# BBR PCF Pipeline Tasks

This is a collection of [Concourse](https://concourse.ci) tasks for backing up a [Pivotal Cloud Foundry](https://pivotal.io/platform) installation using [bbr](https://github.com/cloudfoundry-incubator/bosh-backup-and-restore).

Running regular backups (at least every 24 hours) and storing multiple copies of backup artifacts in different datacenters is highly recommended. The [time](https://github.com/concourse/time-resource) Concourse resource can be added to the pipeline to trigger backups regularly. There are a variety of storage resources such as [S3](https://github.com/concourse/s3-resource) that can be used to move backups to storage. A list of Concourse resources can be found [here](https://concourse.ci/resource-types.html).

To use these concourse tasks you will need to have a worker in a network which has access to your ERT or/and BOSH director. You can find an example template for deploying an external worker [here](https://github.com/concourse/concourse-bosh-deployment/blob/master/cluster/external-worker.yml).

## Tasks

### export-om-installation

#### Inputs

* `bbr-pipeline-tasks-repo`: this repository

#### Outputs

* `om-installation`: a directory containing a installation.zip generated by exporting the Operations Manager installation.

#### Params

* `SKIP_SSL_VALIDATION`: if true, ssl validation will be skipped. Defaults to false
* `OPSMAN_URL`: The OpsManager URL
* `OPSMAN_USERNAME`: The OpsManager username
* `OPSMAN_PASSWORD`: The OpsManager password

### bbr-backup-ert

N.B.: the pipeline assumes you have a tagged concourse worker deployed on the same network as ERT, i.e., the pipeline will use the concourse worker as the jumpbox. Ensure that this worker has enough disk space to accommodate the ERT backup files.

#### Inputs:

* `bbr-pipeline-tasks-repo`: this repository
* `binary`: a directory containing a executable `bbr` file

#### Outputs

* `ert-backup-artifact`: a directory containing ert-backup.tar generated by backing up ERT.

#### Params

* `SKIP_SSL_VALIDATION`: if true, ssl validation will be skipped. Defaults to false
* `OPSMAN_URL`: The OpsManager URL
* `OPSMAN_USERNAME`: The OpsManager username
* `OPSMAN_PASSWORD`: The OpsManager password

### bbr-backup-director

N.B.: the pipeline assumes you have a tagged concourse worker deployed on the same network as the Director, i.e., the pipeline will use the concourse worker as the jumpbox. Ensure that this worker has enough disk space to accommodate the Director backup files.

#### Inputs:

* `bbr-pipeline-tasks-repo`: this repository
* `binary`: a directory containing a executable `bbr` file

#### Outputs

* `director-backup-artifact`: a directory containing director-backup.tar generated by backing up the Director.

#### Params

* `SKIP_SSL_VALIDATION`: if true, ssl validation will be skipped. Defaults to false
* `OPSMAN_URL`: The OpsManager URL
* `OPSMAN_USERNAME`: The OpsManager username
* `OPSMAN_PASSWORD`: The OpsManager password

## Example pipeline

You can set the example pipeline with [fly](https://concourse.ci/fly-cli.html):

```bash
cp secrets.sample.yml secrets.yml
# update secrets.yml with real secrets
fly --target <target> \
    set-pipeline \
    --pipeline bbr-pipeline \
    --config pipeline.sample.yml \
    --load-vars-from secret.yml
```
